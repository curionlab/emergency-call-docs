# ユーザーマニュアル

このマニュアルでは、緊急コールシステムの使い方を発信者（Sender）と受信者（Receiver）それぞれの視点で説明します。

---

## 受信者（Receiver）の使い方

受信者は、緊急通知を受け取る側の人です。事前に登録が必要です。

### 1. 初期設定（受信者登録）

#### ステップ1：PWAをインストール（iPhone推奨）
1. Safari で client URL を開く（例：`https://your-app.com`）
2. 画面下部の「共有」ボタンをタップ
3. 「ホーム画面に追加」を選択
4. ホーム画面から起動

#### ステップ2：通知を許可
1. アプリを開く
2. 「Receiver」を選択
3. 通知の許可を求められたら「許可」をタップ

#### ステップ3：認証コードを取得
発信者（または管理者）に連絡して、あなた専用の認証コードを発行してもらいます。

- 認証コードは6桁の数字（例：`582937`）
- 有効期限は30分

#### ステップ4：受信者IDと認証コードを入力
1. 「Receiver ID」に自分の識別子を入力（例：`parentA`）
2. 「認証コード」に取得した6桁を入力
3. 「サーバーURL」を確認（通常は自動入力済み）
4. 「登録」ボタンをタップ

#### ステップ5：登録完了
「購読登録が完了しました」と表示されれば成功です。

---

### 2. 緊急通知を受け取る

#### 通常の状態
登録後は、アプリを閉じていても通知を受け取れます（バックグラウンドで動作）。

#### 通知が届いたら
1. スマホに通知が表示されます
   - タイトル：「緊急通知」
   - 本文：「緊急コールを受信しました」
2. 通知をタップ
3. 自動的にアプリが開き、通話画面に切り替わります

#### 自動応答
通知タップ後、**自動的に通話が開始**されます（手動操作不要）。

---

### 3. 通話中の操作

#### 画面構成
- **大きい画面**：相手（発信者）のカメラ映像
- **小さい画面（右上）**：自分のカメラ映像

#### ボタン操作
- 🎤 **マイクボタン**：自分の音声をON/OFF
- 📷 **カメラボタン**：自分のカメラをON/OFF
- 👁️ **自分の映像ボタン**：自分の映像表示をON/OFF（相手には影響なし）
- ❌ **通話終了ボタン**：通話を切る

---

### 4. トラブル時の対処

#### 通知が届かない
→ [トラブルシューティング](troubleshooting.md)の「通知が届かない」セクションを参照

#### 通話がつながらない
→ [トラブルシューティング](troubleshooting.md)の「通話が確立しない」セクションを参照

---

## 発信者（Sender）の使い方

発信者は、緊急時に受信者へ通知を送り、通話を開始する側です。

### 1. 初期設定（ログイン）

#### ステップ1：アプリを開く
ブラウザで client URL を開く（例：`https://your-app.com`）

#### ステップ2：Senderを選択
1. 「Sender」を選択
2. パスワードを入力してログイン

---

### 2. 受信者の登録準備（認証コード発行）

新しい受信者を登録する前に、認証コードを発行します。

#### ステップ1：受信者IDを決める
受信者を識別するID（例：`parentA`, `user123`）

#### ステップ2：認証コードを発行
1. 画面下部の「認証コード発行ツール」を使用
2. 「Receiver ID」に決めたIDを入力
3. 「認証コード発行」ボタンをクリック
4. 表示された6桁のコードをメモ（有効期限30分）

#### ステップ3：受信者に伝える
受信者に以下を伝えます：
- Receiver ID
- 認証コード（6桁）
- サーバーURL（必要に応じて）

---

### 3. 緊急通知を送る

#### ステップ1：受信者IDを入力
「Receiver ID」欄に、通知を送りたい受信者のIDを入力

#### ステップ2：緊急コールボタンを押す
大きな赤い「緊急コール」ボタンをクリック

#### ステップ3：通知送信完了
「通知を送信しました」と表示されます。

#### ステップ4：受信者が応答するまで待つ
受信者が通知をタップすると、自動的に通話が開始されます。

---

### 4. 通話中の操作

受信者と同じ操作が可能です。

- 🎤 マイクON/OFF
- 📷 カメラON/OFF
- 👁️ 自分の映像表示ON/OFF
- ❌ 通話終了

---

### 5. 複数の受信者を管理

#### 受信者ごとに認証コードを発行
それぞれ異なるReceiver IDで登録します。

例：
- `parentA` → 認証コード `123456`
- `parentB` → 認証コード `789012`

#### 通知は個別送信
送信時にReceiver IDを指定するため、個別に通知できます。

---

## よくある質問（FAQ）

### Q1. 通知はアプリを閉じていても届きますか？
**A**: はい。Service Workerによりバックグラウンドで動作します（PWAとして追加済みの場合）。

### Q2. 通話料金はかかりますか？
**A**: データ通信料のみです（WebRTCはP2P通信）。電話回線は使用しません。

### Q3. 受信者が複数いる場合、一斉通知できますか？
**A**: 現在は個別送信のみです。一斉送信機能は将来実装予定です。

### Q4. 認証コードを忘れました
**A**: 発信者に再発行してもらってください（30分で自動削除されます）。

### Q5. iPhoneでカメラが映りません
**A**: Safari の設定で「カメラ」の許可を確認してください。

### Q6. スマートフォンで通話がつながりません（特にモバイル回線）
**A**: モバイル回線のIPv4接続では、キャリアグレードNAT（CGNAT）によりP2P接続が失敗することがあります。

**対処法：**
1. スマートフォンがIPv6接続になっているか確認
   - https://test-ipv6.com/ にアクセス
   - 「IPv6接続性: あり」と表示されればOK
2. IPv4のみの場合：
   - **Y!mobileユーザー**: APN設定を `plus.acs.jp.v6` に変更（[詳細](troubleshooting.md#5-スマートフォンがipv6接続になっているか重要)）
   - **他キャリア**: 通常はIPv6自動適用（ドコモ/au/ソフトバンク）
3. それでもダメな場合：Wi-Fi接続で試す、またはTURNサーバー導入を待つ

### Q7. Wi-Fiでは繋がるのに、モバイル回線では繋がりません
**A**: モバイル回線がIPv4のみでCGNATを経由している可能性があります。上記Q6を参照してください。

---

## 次のステップ

- [トラブルシューティング](troubleshooting.md) - 問題が起きたら
- [API リファレンス](api-reference.md) - カスタマイズしたい方向け
