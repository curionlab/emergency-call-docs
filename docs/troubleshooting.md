# トラブルシューティング

このドキュメントでは、緊急コールシステムでよく発生する問題と解決方法をまとめています。

---

## 通知関連

### 通知が届かない

#### チェックリスト

##### 1. 通知許可を確認
- **iPhone**: 設定 → Safari → （該当サイト） → 通知 が「許可」になっているか
- **PC**: ブラウザのアドレスバー左の鍵アイコン → 通知 が「許可」になっているか

##### 2. PWAとして追加されているか（iPhone）
- Safari から直接開いているとPush通知は届きません
- 必ず「ホーム画面に追加」してから使用してください

##### 3. Service Workerが登録されているか
開発者ツールで確認：
1. F12 → Application（アプリケーション）タブ
2. Service Workers を選択
3. `sw.js` が "activated and is running" になっているか

##### 4. サーバーURLが正しいか
- 入力した `serverUrl` にタイプミスがないか
- `http` と `https` の違い
- ポート番号（例：3000）の有無

##### 5. CORS設定（サーバー側）
サーバーの `CLIENT_URL` 環境変数が、クライアントのURLと一致しているか確認。

例：
- Client: `http://localhost:5173`
- Server `.env`: `CLIENT_URL=http://localhost:5173`

##### 6. 購読情報が有効か
受信者画面で「購読情報」を確認：
- `endpoint` が表示されているか
- 空の場合は再登録が必要

---

**注意**: 通知は届くが通話がつながらない場合は、[通話が確立しない](#通話が確立しない)セクションを参照してください（特にIPv4/IPv6の問題）。


---

### 通知は届くが、タップしても何も起きない

#### 原因
Service Worker の `notificationclick` イベントが正しく動作していない可能性。

#### 対処法
1. 開発者ツール → Console でエラーを確認
2. Service Worker を "Unregister" して再登録
3. キャッシュをクリア（ハードリロード: Ctrl+Shift+R / Cmd+Shift+R）

---

### 急に通知が届かなくなった

#### 原因1：購読情報の失効
ブラウザ/OSの都合でPush購読が無効になることがあります。

#### 対処法
1. サーバーログで `410 Gone` エラーを確認
2. 受信者として再登録（認証コードの再発行 → 再登録）

#### 原因2：サーバーの再起動
サーバーを再起動すると `data.json` の内容が失われる場合があります（環境依存）。

#### 対処法
受信者として再登録してください。

---

## 通話関連

### 通話が確立しない

#### チェックリスト

##### 1. カメラ/マイクの許可
- ブラウザの設定で「カメラ」「マイク」が許可されているか
- 初回起動時に許可ダイアログが出なかった場合、手動で許可

##### 2. PeerJSサーバーに接続できているか
開発者ツール → Console で以下を確認：
- `PeerJS接続成功` のログがあるか
- `peer-unavailable` エラーが出ていないか

##### 3. ネットワーク環境
- Receiver と Sender が異なるネットワークにいる場合、NAT越えが必要
- 現在はSTUNのみのため、厳しいNAT環境では接続できない場合あり
- 将来：TURNサーバー導入で改善予定

##### 4. 受信者が通知をタップしたか
発信者がボタンを押しても、受信者が通知をタップしないと通話は開始されません。

##### 5. スマートフォンがIPv6接続になっているか（重要）

**背景**  
モバイル回線（特にY!mobile, 楽天モバイル等）では、IPv4接続時に**キャリアグレードNAT（CGN/CGNAT）** を経由します。この環境では、STUNサーバーだけではP2P接続が確立できない場合があります。

**IPv6接続の利点**  
IPv6では各デバイスがグローバルアドレスを持つため、WebRTCのP2P接続が成功しやすくなります。

**確認方法**  
以下のIPv6判定サイトにスマートフォンでアクセスしてください：

- **test-ipv6.com**: https://test-ipv6.com/
- **IPv6テスト**: https://ipv6-test.com/
- **Google IPv6テスト**: https://ipv6.google.com/

「IPv6接続性: あり」または "IPv6 connectivity: Yes" と表示されればOKです。

**IPv4のみの場合の対処法**

##### Y!mobile ユーザーの場合
1. APN設定でIPv6対応プロファイルを作成
2. 設定手順：
   - 設定 → モバイル通信 → モバイルデータ通信ネットワーク
   - APN: `plus.acs.jp.v6`
   - ユーザー名: `ym`
   - パスワード: `ym`
   - （機種により「構成プロファイル」のインストールが必要な場合あり）
3. iPhone を再起動
4. 再度 https://test-ipv6.com/ で確認

##### 他キャリアの場合
各キャリアのIPv6対応方法を確認してください：
- **ドコモ**: IPv6は自動適用（追加設定不要）
- **au/UQモバイル**: IPv6は自動適用
- **ソフトバンク**: IPv6は自動適用
- **楽天モバイル**: APN設定で `rakuten.jp` → IPv6対応

##### それでもつながらない場合
TURNサーバーが必要です（現在未実装）。将来のアップデートをお待ちください。

---

### 音声は聞こえるが映像が映らない

#### 原因
カメラが他のアプリで使用中、またはカメラ許可がない。

#### 対処法
1. 他のカメラ使用アプリ（Zoom, Skype等）を終了
2. ブラウザのカメラ許可を確認
3. それでもダメな場合、音声のみで通話（フォールバック動作）

---

### 自分の映像が映らない

#### 確認ポイント
- 「自分の映像」ボタンがOFFになっていないか（👁️ボタン）
- カメラボタン（📷）がOFFになっていないか

---

## 認証関連

### 認証コードが使えない

#### 原因1：有効期限切れ
認証コードは発行から30分で無効になります。

#### 対処法
発信者に再発行してもらってください。

#### 原因2：入力ミス
6桁の数字を正確に入力してください（ハイフンやスペース不要）。

---

### ログインできない（Sender）

#### 原因
パスワードが間違っている。

#### 対処法
サーバーの `.env` ファイルで設定した `DEFAULT_PASSWORD` を確認してください。

---

## ローカル開発環境

### localhost で通知が来ない

#### 原因1：ポート不一致
Server の `CLIENT_URL` と Client の起動ポートが合っていない。

#### 対処法
- Server `.env`: `CLIENT_URL=http://localhost:5173`
- Client起動: `npx serve -l 5173`

#### 原因2：Service Workerのキャッシュ
古いService Workerが残っている。

#### 対処法
開発者ツール → Application → Service Workers → "Unregister" → ページ再読み込み

---

### `http://192.168.x.x` では通知が動かない

#### 原因
ローカルIPアドレスでは、ブラウザがPush APIを制限する場合があります。

#### 対処法
`http://localhost` を使用してください（または HTTPS化）。

---

## 本番環境

### HTTPSでないと動かない

#### 原因
Service Worker と Push API は、セキュリティ上 HTTPS が必須です（localhost除く）。

#### 対処法
- Cloudflare Pages, Netlify 等の自動HTTPS対応ホスティングを使用
- または Let's Encrypt で証明書を取得

---

### Renderでサーバーが止まる

#### 原因
Render の無料プランは15分アクセスがないとスリープします。

#### 対処法
- 有料プラン（$7/月）にアップグレード
- 外部から定期的にアクセスする（cron job等）

---

### 通知が日本語で表示されない

#### 原因
Push通知の `title` / `body` が日本語でサーバーから送られていない。

#### 対処法
サーバー側の `/send-notification` 処理を確認し、日本語メッセージを設定してください。

---

## データ消失

### サーバー再起動で受信者情報が消える

#### 原因
`data.json` がファイルシステムに保存されるが、一部ホスティングサービス（Render等）では揮発します。

#### 対処法
- **短期**：受信者に再登録してもらう
- **長期**：データベース（PostgreSQL, MongoDB等）に移行

---

## その他

### エラーログの確認方法

#### Client側
1. F12 → Console タブ
2. 赤字のエラーメッセージを確認

#### Server側
サーバーを起動したターミナルでログを確認。

---

### それでも解決しない場合

以下の情報を添えて、GitHub Issues に報告してください：

1. **環境情報**
   - OS（Windows/Mac/iPhone/Android）
   - ブラウザ（Chrome/Safari/Edge）のバージョン
   - ローカル環境か本番環境か

2. **エラーメッセージ**
   - Console に表示されたエラー（スクリーンショット推奨）
   - サーバーログ

3. **再現手順**
   - どの操作をしたときにエラーが起きたか

---

## 次のステップ

- [セットアップガイド](setup-guide.md) - 環境構築を見直す
- [API リファレンス](api-reference.md) - APIの仕様を確認
